name: shrinkwrap-osx
on:
  workflow_dispatch:

jobs:
  packageosx:
    runs-on: "macOS-latest"
    steps:
    - uses: actions/checkout@v3.1.0
    - name: Set up Python
      uses: actions/setup-python@v4.3.0
      with:
        python-version: "3.11"
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install --upgrade setuptools
        pip install -r package/requirements.txt
    - name: Install app dependencies
      run: |
        python -m venv venv
        source venv/bin/activate
        pip install -r requirements.txt
    - name: Create osx installer
      run: |
         bash ./package/osx.sh
         ls ./dist/
    - name: Upload disk image
      uses: actions/upload-artifact@v3
      with:
        name: Saint_Helens.dmg
        path: Saint_Helens.dmg
        if-no-files-found: error
          
  publish:
    needs: packageosx
    runs-on: ubuntu-latest

    permissions:
      contents: write
      
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: ./artifacts
 
      - name: List artifacts
        run: |
          ls -R ./artifacts
      
      - name: Sparse Checkout
        uses: actions/checkout@v3.1.0
        with:
          path: 'repo'
          sparse-checkout: |
            README.md
            LICENSE
          sparse-checkout-cone-mode: false
      
      - name: Set version
        run: |
          echo "VERSION=0.0.2" >> $GITHUB_ENV
          echo "Release Text" > ./release.body.txt
          echo ${{ env.VERSION }}
        
      - name: Create github release
        uses: softprops/action-gh-release@v1
        with:
          fail_on_unmatched_files: True
          tag_name: ${{ env.VERSION }}
          name: ${{ env.VERSION }}
          body_path: ./release.body.txt
          files: |
            ./artifacts/Saint_Helens.dmg/Saint_Helens.dmg
            ./repo/LICENSE
            ./repo/README.md
